# API Contract Documentation

## Base URL

- **Development**: `http://localhost:8000`
- **Production**: `https://api.refract-iot.example.com` (future)

## Authentication

**Current**: None (prototype)

**Production**: API key or certificate-based authentication required.

## Endpoints

### POST /api/v1/readings

Ingest a device reading.

#### Request

**Headers**:
```
Content-Type: application/json
```

**Body**:
```json
{
  "device_id": "string (required)",
  "ts": "ISO8601 datetime (required)",
  "value": "number (required)",
  "unit": "string (required, 'RI' or 'Brix')",
  // Note: Simulator uses 'RI' only. Brix is supported for compatibility but not generated by simulator.
  "temperature_c": "number (optional)",
  "event_id": "UUID string (optional, for idempotency)"
}
```

**Example**:
```json
{
  "device_id": "DEV001",
  "ts": "2024-01-28T15:30:00Z",
  "value": 1.3330,
  "unit": "RI",
  "temperature_c": 25.0,
  "event_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### Response

**Success (201 Created)**:
```json
{
  "id": 123,
  "device_id": "DEV001",
  "ts": "2024-01-28T15:30:00Z",
  "value": 1.3330,
  "unit": "RI",
  "temperature_c": 25.0,
  "event_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Error (400 Bad Request)**:
```json
{
  "detail": "Invalid unit: XYZ. Must be 'RI' or 'Brix'"
}
```

**Error (400 Bad Request - Duplicate event_id)**:
If `event_id` is provided and already exists, returns the existing reading (idempotent).

#### Validation Rules

- `device_id`: Non-empty string, max 255 chars
- `ts`: Valid ISO8601 datetime
- `value`: 
  - For `unit="RI"`: Range [1.0, 2.0]
  - For `unit="Brix"`: Range [0.0, 100.0]
- `unit`: Must be exactly `"RI"` or `"Brix"` (simulator uses "RI" only)
- `temperature_c`: Optional, range [-50.0, 150.0] if provided
- `event_id`: Optional UUID string for idempotency

#### Idempotency

If `event_id` is provided:
- First request with a given `event_id`: Creates new reading
- Subsequent requests with same `event_id`: Returns existing reading (no duplicate)

This allows devices to safely retry failed requests without creating duplicates.

---

### GET /api/v1/devices

List all devices with status and latest reading.

#### Request

No parameters.

#### Response

**Success (200 OK)**:
```json
{
  "devices": [
    {
      "device_id": "DEV001",
      "name": "Device DEV001",
      "last_seen_at": "2024-01-28T15:30:00Z",
      "status": "OK",
      "latest_reading": {
        "value": 1.3330,
        "unit": "RI",
        "ts": "2024-01-28T15:30:00Z"
      }
    },
    {
      "device_id": "DEV002",
      "name": "Device DEV002",
      "last_seen_at": "2024-01-28T14:00:00Z",
      "status": "STALE",
      "latest_reading": {
        "value": 12.5,
        "unit": "Brix",
        "ts": "2024-01-28T14:00:00Z"
      }
    }
  ]
}
```

**Status Values**:
- `"OK"`: Device seen within last 15 minutes
- `"STALE"`: Device seen within last 24 hours but > 15 minutes ago
- `"OFFLINE"`: Device not seen in last 24 hours or never

---

### GET /api/v1/devices/{device_id}/readings

Get reading history for a specific device.

#### Request

**Path Parameters**:
- `device_id` (string, required): Device identifier

**Query Parameters**:
- `limit` (integer, optional): Maximum number of readings to return
  - Default: 100
  - Min: 1
  - Max: 1000

#### Response

**Success (200 OK)**:
```json
{
  "device_id": "DEV001",
  "readings": [
    {
      "id": 123,
      "ts": "2024-01-28T15:30:00Z",
      "value": 1.3330,
      "unit": "RI",
      "temperature_c": 25.0
    },
    {
      "id": 122,
      "ts": "2024-01-28T15:15:00Z",
      "value": 1.3328,
      "unit": "RI",
      "temperature_c": 24.9
    }
  ]
}
```

**Error (404 Not Found)**:
```json
{
  "detail": "Device not found"
}
```

**Ordering**: Readings are returned in descending order by timestamp (newest first).

---

### GET /health

Health check endpoint for load balancers and monitoring.

#### Request

No parameters.

#### Response

**Success (200 OK)**:
```json
{
  "status": "healthy"
}
```

---

## Error Responses

All error responses follow this format:

```json
{
  "detail": "Error message describing what went wrong"
}
```

### HTTP Status Codes

- `200 OK`: Successful GET request
- `201 Created`: Successful POST request (reading created)
- `400 Bad Request`: Invalid request payload or validation error
- `404 Not Found`: Resource not found (e.g., device_id doesn't exist)
- `500 Internal Server Error`: Server error (should not happen in normal operation)

## Rate Limiting

**Current**: None (prototype)

**Production**: Recommended limits:
- Per device: 1 request per 15 minutes (reading interval)
- Per IP: 100 requests per minute
- Burst: Allow 5 requests in 10 seconds

## Data Models

### Device

```typescript
interface Device {
  device_id: string;        // Primary key
  name: string | null;       // Human-readable name
  last_seen_at: string | null; // ISO8601 datetime
  created_at: string;        // ISO8601 datetime
}
```

### Reading

```typescript
interface Reading {
  id: number;               // Auto-increment primary key
  device_id: string;        // Foreign key to devices
  ts: string;              // ISO8601 datetime
  value: number;            // Reading value (4 decimal places)
  unit: string;             // "RI" or "Brix"
  temperature_c: number | null; // Temperature in Celsius (2 decimal places)
  event_id: string | null;  // UUID for idempotency (unique)
  created_at: string;       // ISO8601 datetime
}
```

## Example Requests

### cURL Examples

**Post a reading**:
```bash
curl -X POST http://localhost:8000/api/v1/readings \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "DEV001",
    "ts": "2024-01-28T15:30:00Z",
    "value": 1.3330,
    "unit": "RI",
    "temperature_c": 25.0
  }'
```

**Get devices**:
```bash
curl http://localhost:8000/api/v1/devices
```

**Get device readings**:
```bash
curl "http://localhost:8000/api/v1/devices/DEV001/readings?limit=50"
```

### C Client Example

See `device/c-client/src/main.c` for full implementation.

```c
// Simplified example
char json[] = "{\"device_id\":\"DEV001\",\"ts\":\"2024-01-28T15:30:00Z\",\"value\":1.3330,\"unit\":\"RI\"}";
http_post_reading("http://localhost:8000", "/api/v1/readings", json);
```

### Flutter/Dart Example

See `web/lib/api/client.dart` for full implementation.

```dart
final client = ApiClient();
final devices = await client.getDevices();
final readings = await client.getDeviceReadings('DEV001', limit: 100);
```

## OpenAPI Specification

The API includes an auto-generated OpenAPI specification available at:

- **Swagger UI**: `http://localhost:8000/docs`
- **ReDoc**: `http://localhost:8000/redoc`
- **OpenAPI JSON**: `http://localhost:8000/openapi.json`

## Versioning

Current version: `v1`

Future versions will be added as new path prefixes (e.g., `/api/v2/readings`) to maintain backward compatibility.

## Changelog

### v1.0.0 (Current)
- Initial API contract
- Reading ingestion with idempotency
- Device listing with status
- Reading history queries
